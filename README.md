# **Network Analysisç½‘ç»œåˆ†æå·¥å…·**

## **å‰è¨€**

å†™ä¸‹è®°å½•è‡ªå·±å¼€å‘Network Analysisè¿™ä¹ˆä¸€ä¸ªå°å·¥å…·çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œæƒ³è¦å®ç°çš„åŠŸèƒ½å¾ˆç®€å•å°±æ˜¯ å®ç°ä¸€ä¸ªç±»ä¼¼åƒChromeæµè§ˆå™¨networkè¿™ä¸ªä¸€ä¸ªå°å·¥å…·(é¡ºå¸¦å®ç°äº†performanceæ€§èƒ½åˆ†æ, æ­£å¥½æµ‹è¯•ä¸€ä¸‹ä¹‹å‰çš„åšå®¢é¡¹ç›®)

è¿™ä¸ªæƒ³æ³•çš„èƒŒæ™¯: å½“æˆ‘ä»¬æµ‹è¯•æ¥å£çš„æ—¶å€™å¤§éƒ¨åˆ†äººéƒ½æ˜¯ç”¨çš„postmanè¿™ä¸ªç¨‹åºæ¥è·å– get post delete put ç­‰è¿™æ ·ä¸€äº›restfulè§„åˆ™æ¥å£ï¼Œè€Œè¿™ä¼¼ä¹æ²¡æœ‰è¯·æ±‚ä¸€ä¸ªdocumentçš„åŠŸèƒ½ï¼Œé¡¶å¤šå°±æ˜¯æŠŠè¯·æ±‚å›æ¥çš„æ•°æ®ä¹Ÿå°±æ˜¯ç®€å•çš„å°†bodyæ‰“å°ä¸Šå»

å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ç»å…¸çš„è€å¤§å“¥æŠ“åŒ…ç¥å™¨ Wireshark æˆ–è€… Charles è¿™æ ·çš„å·¥å…·ï¼Œç†è®ºä¸Šæ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯æ€ä¹ˆç»Ÿè®¡æ‰€éœ€è¦çš„æ•°æ®ï¼Œè¿™å¯èƒ½å°±æ˜¯ä¸€ä¸ªéš¾é¢˜äº†

æ‰€ä»¥æˆ‘é€‰æ‹©äº†ä¸€ä¸ªé›†æˆChromium & Node.js & Native APISçš„Electronæ¥å¼€å‘ä¸€ä¸ªè¿™æ ·çš„æ¡Œé¢å·¥å…·ã€‚

![Electronæ¶æ„](http://qiniu.mrshulan.com/electron%E6%9E%B6%E6%9E%84.png)

## Electronçš„å¼€å‘ç®€ä»‹

æˆ–è®¸ä½ ä¼šé—®æˆ‘ä¸ºä½•æ²¡æœ‰é€‰æ‹©Nwå¼€å‘ï¼Œæ€ä¹ˆè¯´å‘¢ï¼Œç¡®å®Nwå’ŒElectronéƒ½å¯ä»¥å¼€å‘ï¼Œä¸è¿‡æˆ‘æ—©å¯¹Electronæœ‰ç‚¹äº†è§£ï¼Œè€Œåˆå¤©å¤©ä½¿ç”¨github ä»¥åŠ vscodeå¼€å‘ï¼Œé¡ºå…¶è‡ªç„¶å°±å­¦äº†ä¸€ä¸‹Electron(æœ‰å…´è¶£çš„å¯ä»¥å»äº†è§£ä¸€ä¸‹Electronçš„èƒŒæ™¯)

æˆ‘åœ¨Electronçš„å®˜ç½‘æ‰¾è§ä¸€ä¸ªrepo[httptoolkit-desktop](https://github.com/httptoolkit/httptoolkit-desktop) åŠŸèƒ½æœ‰ç‚¹å¼ºå¤§ï¼Œéƒ½å¯ä»¥æ”¯æŒcurlçš„ç›‘å¬ï¼Œæ›´ä¸ç”¨è¯´Chromeã€Filefoxäº†ï¼Œæˆ‘çœ‹äº†çœ‹å…¶ä»£ç (çœ‹ä¸æ‡‚è¿™ä¸ªç»„ç»‡ç»“æ„ğŸ˜¢)ã€‚

Electronçš„å­¦ä¹ è¿‡ç¨‹å…¶å®å¾ˆç®€å•ï¼Œè·Ÿç€æ–‡æ¡£å†™ä¸€äº›[demo](https://github.com/Mrshulan/Electron_network/tree/master/demo)å³å¯,è¿™é‡Œæƒ³æ€»ç»“çš„æ˜¯é‡Œè¾¹çš„è¿›ç¨‹å…³ç³»

![Electronè¿›ç¨‹](http://qiniu.mrshulan.com/electron%E8%BF%9B%E7%A8%8B.png)

è¿™ä¸ªå›¾é‡Œè¾¹å¯ä»¥çœ‹åˆ°ä¸€ä¸ª**ä¸»è¿›ç¨‹(ipcMain)**ç®¡ç†ç€å¤šä¸ª**æ¸²æŸ“è¿›ç¨‹(ipcRenderer)**(æ¯ä¸ªæ¸²æŸ“è¿›ç¨‹ç›¸äº’ç‹¬ç«‹)

Electronè¿è¡Œæ—¶ä¼šé¦–å…ˆæ‰¾å‡º(ç±»æ¯”ä¸€ä¸‹CRAçš„å…¥å£)`package.json`ä¸­çš„`main`å­—æ®µæ ‡æ˜è„šæœ¬å…¥å£çš„è¿›ç¨‹ç§°ä¸º**ä¸»è¿›ç¨‹**ï¼Œåœ¨ä¸»è¿›ç¨‹åˆ›å»ºwebé¡µé¢æ¥å±•ç¤ºç”¨æˆ·é¡µé¢ï¼Œ**ä¸€ä¸ªelectronæœ‰ä¸”åªæœ‰ä¸€ä¸ªä¸»è¿›ç¨‹**Electronä½¿ç”¨Chromiumæ¥å±•ç¤ºwebé¡µé¢ï¼Œæ¯ä¸ªé¡µé¢è¿è¡Œåœ¨è‡ªå·±çš„**æ¸²æŸ“è¿›ç¨‹**ä¸­ã€‚

### è¿›ç¨‹é€šä¿¡

- sendMsg ä¸»è¿›ç¨‹å¤„ç†æ¸²æŸ“è¿›ç¨‹å‘æ¥çš„æ•°æ®
- sendFeedback ä¸»è¿›ç¨‹å¤„ç†æ¸²æŸ“è¿›ç¨‹å‘æ¥çš„æ•°æ®, å¹¶åé¦ˆç»™æ¸²æŸ“è¿›ç¨‹
- sendsync  ä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹åŒæ­¥é€šä¿¡

ä»¥ä¸Šçš„ä¸€äº›æ–¹å¼ï¼Œéƒ½æ˜¯é€šè¿‡ .send .on äº‹ä»¶ç›‘å¬çš„æ¨¡å¼(ç±»æ¯”ä¸€ä¸‹å‘å¸ƒè®¢é˜…æ¨¡å¼)ï¼Œå°±æ˜¯ä¸€ä¸ªEventEmitterç±»çš„å®ä¾‹ï¼Œå­¦èµ·æ¥ä¹Ÿæ¯”è¾ƒå¿«é€Ÿï¼Œæ³¨æ„ä¸€ä¸‹æ ¼å¼æ—¢å¯

é‚£ä¹ˆæ¸²æŸ“è¿›ç¨‹ä¹‹é—´æ€ä¹ˆé€šä¿¡å‘¢ï¼Ÿå¯è§[demo] news.htmlå¼€å¯æ–°çª—å£

- localstorage(åŸŸ)
- çª—å£id + webContents

æ¸²æŸ“è¿›ç¨‹å¯ä»¥é€šè¿‡electron.remoteè¿™ä¸ªæ¨¡å—å¯ä»¥è®©æ¸²æŸ“è¿›ç¨‹è®¿é—®/ä½¿ç”¨ä¸»è¿›ç¨‹çš„æ¨¡å—ï¼Œåªéœ€è¦è§£æ„å‡ºæ¥ï¼Œæ¯”æ–¹è¯´å¯ä»¥å¼€ä¸ªçª—å£ `const { remote: {BrowserWindow}} = require('electron');`

é€šè¿‡ `remote` å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ä¸å¿…å‘é€è¿›ç¨‹é—´æ¶ˆæ¯æ¥è¿›è¡Œé€šä¿¡ã€‚ä½†å®é™…ä¸Šï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨è¿œç¨‹å¯¹è±¡çš„æ–¹æ³•ã€å‡½æ•°æˆ–è€…é€šè¿‡è¿œç¨‹æ„é€ å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå®é™…ä¸Šéƒ½æ˜¯åœ¨å‘é€ä¸€ä¸ªåŒæ­¥çš„è¿›ç¨‹é—´æ¶ˆæ¯

ä¹Ÿå°±æ˜¯è¯´ï¼Œ`remote` æ–¹æ³•åªæ˜¯ä¸ç”¨è®©æˆ‘ä»¬æ˜¾å¼çš„å†™å‘é€è¿›ç¨‹é—´çš„æ¶ˆæ¯çš„æ–¹æ³•è€Œå·²ã€‚åœ¨ä¸Šé¢é€šè¿‡ `remote` æ¨¡å—åˆ›å»º `BrowserWindow` çš„ä¾‹å­é‡Œã€‚æˆ‘ä»¬åœ¨æ¸²æŸ“è¿›ç¨‹ä¸­åˆ›å»ºçš„ `BrowserWindow` å¯¹è±¡å…¶å®å¹¶ä¸åœ¨æˆ‘ä»¬çš„æ¸²æŸ“è¿›ç¨‹ä¸­ï¼Œå®ƒåªæ˜¯è®©ä¸»è¿›ç¨‹åˆ›å»ºäº†ä¸€ä¸ª `BrowserWindow`å¯¹è±¡ï¼Œå¹¶è¿”å›äº†è¿™ä¸ªç›¸å¯¹åº”çš„è¿œç¨‹å¯¹è±¡ç»™äº†æ¸²æŸ“è¿›ç¨‹ã€‚

###  ä¸€ä¸ªå°é—®é¢˜

æˆ‘åœ¨macä¸‹ä½¿ç”¨çš„æ—¶å€™ï¼Œè·‘å‡ºæ¥çš„ç¨‹åºé»˜è®¤æ˜¯ä¸æ”¯æŒ ç²˜è´´å¤åˆ¶çš„ï¼Œ æ‰€ä»¥éœ€è¦åœ¨menué‡Œè¾¹çš„åšä¸€ä¸ªæ˜ å°„ã€‚

## å¦‚ä½•ç›‘å¬åˆ°ä¸€æ¬¡ç½‘é¡µè¯·æ±‚é™„å¸¦çš„èµ„æºè¯·æ±‚

Electronæä¾›ä¸€ä¸ªnetæ¨¡å—ï¼Œä½†æ˜¯ä»…ä»…åªæ”¯æŒä¸€æ¬¡è¯·æ±‚ï¼Œæ¯”æ–¹è¯´è¯·æ±‚https://baidu.comåªæ˜¯æ‹¿åˆ°ä¸€æ¬¡ header å’Œ body

è¿™é‡Œå¯èƒ½ä¼šæƒ³åˆ°ï¼Œè¿™å·²ç»æ‹¿åˆ°äº†body çš„documentäº†ï¼Œæˆ‘æ­£åˆ™åŒ¹é…ä¹‹ååœ¨é€’å½’è¯·æ±‚ä¸å°±å¯ä»¥äº†ï¼Ÿä¸ºæ­¤æˆ‘åšäº†ä¸€ä¸ªtestï¼Œ

- æ­£åˆ™å¦‚ä½•åŒ¹é…è¿™æ ·ä¸€ä¸ªåºå¤§çš„htmlæ–‡ä»¶ä¸€äº›å¤–è¾¹èµ„æºçš„è¯·æ±‚å®Œæ•´æ€§ï¼Œæ¢å¥è¯è¯´ï¼Œä½ èƒ½ä¸èƒ½ç™¾åˆ†ç™¾ç¡®ä¿ã€‚
- é€’å½’çš„æ•ˆç‡ï¼Œæœ‰æ²¡æœ‰è€ƒè™‘è¿‡ã€‚
- ä¸€äº›è¯·æ±‚å›æ¥çš„èµ„æºè¿˜éœ€è¦å…¶ä»–çš„ä¾èµ–æ˜¯ä¸æ˜¯è¿˜è¦è€ƒè™‘ï¼Œæˆ–æ˜¯è¦è€ƒè™‘ï¼Œé€’å½’å¦‚æœæ­»å¾ªç¯äº†æ€ä¹ˆå§ï¼Œè¿™ä¸ªè¾¹ç•Œæ€ä¹ˆå¤„ç†ã€‚

è¿™é‡Œå¯ä»¥è¿™ä¹ˆåš

- Chrome headlessæ¨¡å¼

  - `chrome --headless --remote-debugging-port=9222 --crash-dumps-dir=/tmp` ç›‘å¬è¿œç¨‹ç«¯å£(å¦‚æœä¸æ˜¯headlessæ¨¡å¼åˆ™æ— æ•ˆæœ) ä¹Ÿå¯ä»¥åœ¨åè¾¹ç›´æ¥åŠ éœ€è¦æ‰“å¼€çš„åŸŸåï¼Œæ­¤æ—¶macä¼šè‡ªåŠ¨æ‰“å¼€ä¸€ä¸ªdevtools(æ— GPUç•Œé¢) ç‚¹å‡»å°çª—å£ä¼šè·³å‡ºä¸€ä¸ª Websocketç›‘å¬ç•Œé¢(å…¶åŸç†ä¹Ÿæ˜¯WS)

- chrome-remote-interface & puppeteer

  - é€’è¿›æ€è·¯ headless => chrome-remote-interface (CDP)=> puppeteer => script.js(Node.js)
    - å¿…é¡»å€ŸåŠ©headlessè¿›è¡Œé»‘çª—å£ç›‘å¬ç½‘ç»œï¼Œåªéœ€åœ¨æˆ‘ä»¬çš„è„šæœ¬é‡Œè¾¹requireå³å¯,åˆ©ç”¨å…¶é‡Œè¾¹çš„Client Page Networkæ¨¡å—çš„ä¸€äº› ç›‘å¬è¯·æ±‚å‡½æ•°å³å¯è¾¾åˆ°å…¨ç¨‹ç›‘å¬request,`Network.requestWillBeSentã€Network.loadingFailedã€ Network.loadingFinishedã€ Network.responseReceivedã€Network.requestServedFromCacheã€ `ä¸å½¼æ—¶çš„Electron netæ¨¡å—ç›¸å·®ç”šè¿œ
    - å¦‚æœæ²¡æœ‰å¼€å¯headless å°±ä¼šå‡ºé”™"Error: connect ECONNREFUSED 127.0.0.1:9222"
  - performanceåˆ†æ å€ŸåŠ© Runtime.evaluate å½“ `Event.loadEventFired ` mock console.log expressionæ‹¿åˆ°`window.performance.timing.toJSON()` å¯åšè‡ªåŠ¨åŒ–æ€§èƒ½æµ‹è¯•å·¥å…·

  è¿™é‡Œæœ‰ä¸ªå‘

  - client.close & sendFeedbackToRenderå¼‚æ­¥é€»è¾‘å…ˆåé¡ºåº, å¦‚æœsendFeedbackToRenderå¤„åœ¨å¼‚æ­¥é€»è¾‘æœ€å è€Œ closeå¤„ä»»åŠ¡é˜Ÿåˆ—å‰è¾¹ç›´æ¥å°±æ²¡æœ‰then, ä¹Ÿè½®ä¸åˆ° feedback åé¦ˆã€‚

### å‡ ä¸ªé—®é¢˜(é™¤å»ä¸Šé¢ä¸¤ä¸ª)

- å®ç°ä¸€ä¸ªç±»å‹Table çš„æ ·å¼ï¼Œæˆ‘é‡‡ç”¨çš„æ˜¯ul li dl dt ddæ¨¡å¼,æ•°æ®ä¸€åˆ—ä¸€åˆ—çš„ï¼Œè€Œæˆ‘ä¹‹å‰æ‰“åŒ…çš„æ•°æ®çš„æ˜¯rowçš„æ ¼å¼ï¼Œå†™ä»£ç çš„æ—¶å€™æ²¡æœ‰æ€è€ƒæ¸…æ¥šï¼Œç›´æ¥å°±æ˜¯ä¸€ä¸ªmap..ç„¶åå‘ç°ä¸å¯¹ï¼Œæ˜¾ç„¶è¿™æ ·çš„å…³ç³»ä¸æ˜¯è¿™æ ·çš„ï¼Œæ‰€ä»¥éœ€è¦å†æ¬¡æ‰“åŒ…æˆcolæ ¼å¼ã€‚
- å½“ä¼ è¾“åè®®æ˜¯h2æ—¶å€™ï¼Œæˆ‘è§£æ„å‡ºæ¥çš„å€¼Content-Length æ˜¯0 (åˆ†æä¸€æ³¢ http2.0æ˜¯ æµå’Œå¸§çš„æ¦‚å¿µ è¦ä½¿ç”¨ binary accept-range è§£æçš„å¥½æœ‰é“ç†â€¦.)ï¼Œ å…¶å®ä¸æ˜¯è¿™æ ·çš„(äº§ç”Ÿçš„ç»“æœä¸æ˜¯è¿™ä¸ª) è€Œæ˜¯è§£æ„ content-length, å±…ç„¶headersé‡Œè¾¹æ˜¯ä¸ªå°å†™â€¦..

- é‡‡ç”¨Electron å’Œ React åŒæ—¶æ‰“åŒ…çš„æ—¶å€™ æœ‰ä¸€ä¸ªconflictï¼Œä»–ä»¬é»˜è®¤åŒæ—¶ä¼šæ¶‰åŠbuildæ–‡ä»¶ è€Œ CRA npm run build æ˜¯æå‰ä¸€æ­¥ build æ‰€ä»¥ Electron çš„é»˜è®¤å…¥å£æ–‡ä»¶ ä¼šå‡ºç°ä¸å­˜åœ¨çš„æŠ¥é”™ï¼Œå¯åœ¨ scripts åè¾¹ ä½¿ç”¨ -em.mainå°† ä¸»è¿›ç¨‹æ–‡ä»¶å¤åˆ¶è¿‡å»ï¼Œè¿™é‡Œæ“ä½œçš„æ—¶å€™å¼€å§‹å¯èƒ½ä¼šæƒ³ç€ï¼Œå•çº¯çš„å¤åˆ¶ä¼šä¸ä¼šæœ‰è·¯å¾„é—®é¢˜ï¼Œå…¶å®å¤šè™‘äº†ï¼Œç›¸å¯¹è·¯å¾„ï¼Œè¿™ä¸ªç›¸å¯¹ç¡®å®å°±æ˜¯å¹³è¡Œç§»åŠ¨è¿‡å»çš„ã€‚
- åœ¨ä¼˜åŒ–æ–¹é¢ï¼Œåœ¨ electron-builder æ–¹å¼ä¸‹ electronè¿™ä¸ªæ˜¯ä¸èƒ½æ”¯æŒ -Sçš„, ä¹Ÿå°±æ˜¯è¯´ä»–å¿…é¡»æ˜¯-Då®‰è£…ï¼ŒåŸå› å¾ˆç®€å•ï¼ŒElectronæ‰“åŒ…çš„æ—¶å€™ä¼šé»˜è®¤æŠŠdependenciesæ‰“è¿›å»ï¼Œè€Œè¿™æ°å¥½å°±æ˜¯ä¸€ä¸ªä¼˜åŒ–ç‚¹ï¼Œèƒ½devçš„ä¸€å®šè¦devã€‚æ‰“åŒ…åçš„å‹ç¼©ä½“ç§¯ä¾æ—§æ¯”è¾ƒå¤§â€¦,Electron åŸºäº Chromiumå’ŒNode, ä¹Ÿå°±æ˜¯ä»–ä¸¤å¿…é¡»æ‰“åŒ…è¿›å»..., æœ¬æ¥æƒ³çœ‹ä¸€çœ‹electron-react-boilerplateè¿™ä¸ªä¼˜ç§€çš„è„šæ‰‹æ¶æœ‰æ²¡æœ‰ä¼˜åŒ–å¾ˆåˆ°ä½çš„åœ°æ–¹ï¼Œæ¯”æ–¹è¯´ webpackå¤§æ³•æŠ½ç¦»æŠ½ç¦»ï¼Œç„¶åå‘ç°å¹¶æ²¡æœ‰ yarn run buildæ¯”æˆ‘çš„å¤§å¤šäº†ã€‚

## Network Analysisé¢„è§ˆ

ä»¥ä¹‹å‰åšä¸ªåšå®¢é¡¹ç›®æµ‹è¯•ä¸€æ³¢(é‚£ä¸ªé™æ€èµ„æºçš„sizeä¸ºä½•æ˜¯0å¯ä»¥æ€è€ƒæ€è€ƒğŸ¤”)

![è¿è¡Œå›¾ç‰‡](http://qiniu.mrshulan.com/networkanalysis%E8%BF%90%E8%A1%8C%E5%9B%BE.png)

CSR performanceæµ‹è¯•ç»“æœ([çº¿ä¸Šåœ°å€](http://mrshulan.xin/blog/) [é¡¹ç›®åœ°å€](https://github.com/Mrshulan/Muti_ShareBlog_FE))

![CSR performance](http://qiniu.mrshulan.com/networkblog%E6%B5%8B%E8%AF%95.png)

SSR performanceæµ‹è¯•ç»“æœ([çº¿ä¸Šåœ°å€](http://mrshulan.xin/blogssr/) [é¡¹ç›®åœ°å€](https://github.com/Mrshulan/Muti_ShareBlog_SSR))

![ssr performance](http://qiniu.mrshulan.com/networkblogssr%E6%B5%8B%E8%AF%95.png)

## å…¶ä»–

å¦‚æœå–œæ¬¢ æ¬¢è¿(å­¬ä¹Ÿ)ç»™ä¸ªstar , æ¥è‡ªä¸€ä¸ªå­¦å¼Ÿ(é©¬ä¸Šç§‹æ‹›)çš„ä¹è®¨è„¸.jpg ğŸ˜‚

> æ€»ç»“æˆ‘è¿™ä¸€å¹´å­¦ä¹ çš„æœ€å¤§æ„Ÿè§¦å°±æ˜¯: çŸ¥è¯†ä¸€å®šè¦å½¢æˆä½“ç³»
>
> é™„ä¸Šæˆ‘çš„ä»£ç ä»“åº“[**Go-ahead_FE**](https://github.com/Mrshulan/Go-ahead_FE) é‡Œè¾¹å•¥éƒ½æœ‰çœŸçš„~